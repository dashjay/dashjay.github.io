<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.73.0" />


<title>golangä¸‹mapçš„æ€§èƒ½åˆ†æ - Dashjay&#39;s</title>
<meta property="og:title" content="golangä¸‹mapçš„æ€§èƒ½åˆ†æ - Dashjay&#39;s">




  






<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">







</head>

<body>
  <div class="wrapper">
    <header class="header">
      <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">Home</a></li>
    
    <li><a href="https://learncppcn.github.io/">LearnCPPä¸­æ–‡ç¿»è¯‘</a></li>
    
    <li><a href="/cv">CV</a></li>
    
    <li><a href="/daily">æˆ‘åœ¨åšä»€ä¹ˆï¼Ÿ</a></li>
    
    <li><a href="/open_source">Contribution</a></li>
    
  </ul>
</nav>

    </header>

<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    


    <h1 class="article-title">golangä¸‹mapçš„æ€§èƒ½åˆ†æ</h1>

    
    <span class="article-date">2020-01-12</span>
    

    

    

    <div class="article-content">
      
<h2 id="golang-ä¸­-map-æ€§èƒ½ä¼˜åŒ–ä½é˜¶">golang ä¸­ map æ€§èƒ½ä¼˜åŒ–[ä½é˜¶] <a href="#golang-%e4%b8%ad-map-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e4%bd%8e%e9%98%b6">Â¶</a></h2>

<h3 id="ç®€å•ä»‹ç»">ç®€å•ä»‹ç» <a href="#%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d">Â¶</a></h3>
<p>golang ä¸­çš„ build-in çš„ map è¿™ä¸ª map æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªå®¶ä¼™ã€‚
ä¸ºäº†æµ‹è¯•å¤šä¸ª map çš„æ€§èƒ½æˆ‘å†™äº†ä¸ªæ¥å£ Map</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">type</span> Map <span style="color:#fff;font-weight:bold">interface</span> {
 Set(key <span style="color:#fff;font-weight:bold">string</span>, val <span style="color:#fff;font-weight:bold">interface</span>{})
 Get(key <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">interface</span>{}, <span style="color:#fff;font-weight:bold">bool</span>)
 Del(key <span style="color:#fff;font-weight:bold">string</span>)
}

</code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¿™æ˜¯å°è£…çš„æ™®é€šçš„ map</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">type</span> OriginMap <span style="color:#fff;font-weight:bold">struct</span> {
 m <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}
}

<span style="color:#fff;font-weight:bold">func</span> NewOriginMap() *OriginMap {
 <span style="color:#fff;font-weight:bold">return</span> &amp;OriginMap{m: <span style="color:#fff;font-weight:bold">make</span>(<span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{})}
}

<span style="color:#fff;font-weight:bold">func</span> (o *OriginMap) Get(key <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">interface</span>{}, <span style="color:#fff;font-weight:bold">bool</span>) {
 v, ok := o.m[key]
 <span style="color:#fff;font-weight:bold">return</span> v, ok
}
<span style="color:#fff;font-weight:bold">func</span> (o *OriginMap) Set(key <span style="color:#fff;font-weight:bold">string</span>, value <span style="color:#fff;font-weight:bold">interface</span>{}) {
 o.m[key] = value
}

<span style="color:#fff;font-weight:bold">func</span> (o *OriginMap) Del(key <span style="color:#fff;font-weight:bold">string</span>) {
 <span style="color:#fff;font-weight:bold">delete</span>(o.m, key)
}
</code></pre></td></tr></table>
</div>
</div><p>åˆ«çœ‹ä¸€å †ä»£ç ï¼Œå…¶å®å°±æ˜¯ get å’Œ set æ“ä½œã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è¦ä½¿ç”¨ golang è‡ªå¸¦çš„ test å·¥å…·</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">func</span> TestOriginMaps(t *testing.T) {
 hm := NewOriginMap()
 wg := sync.WaitGroup{}
 <span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; Writer; i++ {
  wg.Add(<span style="color:#ff0;font-weight:bold">1</span>)
  <span style="color:#fff;font-weight:bold">go</span> <span style="color:#fff;font-weight:bold">func</span>(wg *sync.WaitGroup) {
   <span style="color:#fff;font-weight:bold">for</span> k := <span style="color:#ff0;font-weight:bold">0</span>; k &lt; <span style="color:#ff0;font-weight:bold">100</span>; k++ {
    hm.Set(strconv.Itoa(k), k*k)
    val, _ := hm.Get(strconv.Itoa(k))
    t.Logf(<span style="color:#0ff;font-weight:bold">&#34;Get %d = %d&#34;</span>, k, val)
   }
   wg.Done()
  }(&amp;wg)
 }
 wg.Wait()
}
</code></pre></td></tr></table>
</div>
</div><p>è¿™å…¶ä¸­æœ‰ä¸ªå˜é‡ Writer å°±æ˜¯å†™è€…çš„æ•°é‡ï¼Œå¦‚æœåªæœ‰ 1 çš„æ—¶å€™ç¨‹åºèƒ½å®‰å…¨è¿è¡Œé€€å‡º</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#ff0;font-weight:bold">1264</span> <span style="color:#f00">Â±</span> : <span style="color:#fff;font-weight:bold">go</span> test map_test/map_performance_test.<span style="color:#fff;font-weight:bold">go</span> -v           <span style="color:#f00">â</span> [<span style="color:#ff0;font-weight:bold">3</span>h1m] <span style="color:#f00">âœ¹</span> <span style="color:#f00">âœš</span> <span style="color:#f00">âœ­</span>
=== RUN   TestOriginMaps
--- PASS: TestOriginMaps (<span style="color:#ff0;font-weight:bold">0.00</span>s)
    map_performance_test.<span style="color:#fff;font-weight:bold">go</span>:<span style="color:#ff0;font-weight:bold">71</span>: Get <span style="color:#ff0;font-weight:bold">0</span> = <span style="color:#ff0;font-weight:bold">0</span>
    map_performance_test.<span style="color:#fff;font-weight:bold">go</span>:<span style="color:#ff0;font-weight:bold">71</span>: Get <span style="color:#ff0;font-weight:bold">1</span> = <span style="color:#ff0;font-weight:bold">1</span>
......
    map_performance_test.<span style="color:#fff;font-weight:bold">go</span>:<span style="color:#ff0;font-weight:bold">71</span>: Get <span style="color:#ff0;font-weight:bold">99</span> = <span style="color:#ff0;font-weight:bold">9801</span>
PASS
ok      command-line-arguments  <span style="color:#ff0;font-weight:bold">0.339</span>s
</code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æŠŠ Writer æ•°é‡æ”¹ä¸º 2</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#ff0;font-weight:bold">1264</span> <span style="color:#f00">Â±</span> : <span style="color:#fff;font-weight:bold">go</span> test map_test/map_performance_test.<span style="color:#fff;font-weight:bold">go</span> -v             [<span style="color:#ff0;font-weight:bold">3</span>h2m] <span style="color:#f00">âœ¹</span> <span style="color:#f00">âœš</span> <span style="color:#f00">âœ­</span>
=== RUN   TestOriginMaps
fatal <span style="color:#fff;font-weight:bold">error</span>: concurrent <span style="color:#fff;font-weight:bold">map</span> writes

goroutine <span style="color:#ff0;font-weight:bold">21</span> [running]:
</code></pre></td></tr></table>
</div>
</div><p>ç«‹é©¬å°±çˆ†ç‚¸äº†ã€‚é‚£ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿgolang è‡ªå·±å®˜æ–¹å¿ƒç†æ²¡æ•°ä¹ˆï¼Ÿ</p>
<p>å½“ç„¶æœ‰æ•° golang å¼€å‘è€…å…¶ä¸­ä¹‹ä¸€å¯æ˜¯æ‹¿å›¾çµå¥–çš„ã€‚ä½ å¯ä»¥ç‚¹å‡»
<a href="https://stackoverflow.com/questions/11063473/map-with-concurrent-access" title="stackoverflowè¿™é‡Œ" target="_blank" rel="noopener">stackoverflow ä¸Šçš„è®¨è®º</a>
å’Œ
<a href="https://github.com/golang/go/issues/21035" title="github ä¸Šçš„è®¨è®º" target="_blank" rel="noopener">github è¿™é‡Œ</a>
å»æŸ¥çœ‹ç›¸å…³çš„ issue</p>

<h3 id="sync-map">Sync. Map <a href="#sync-map">Â¶</a></h3>
<p>è¿™æ˜¯æŸå¤§ä½¬æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¯•è¯•</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">type</span> SyncMap <span style="color:#fff;font-weight:bold">struct</span> {
 m sync.Map
}

<span style="color:#fff;font-weight:bold">func</span> NewSyncMap() *SyncMap {
 <span style="color:#fff;font-weight:bold">return</span> &amp;SyncMap{}
}

<span style="color:#fff;font-weight:bold">func</span> (o *SyncMap) Get(key <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">interface</span>{}, <span style="color:#fff;font-weight:bold">bool</span>) {
 v, ok := o.m.Load(key)
 <span style="color:#fff;font-weight:bold">return</span> v, ok
}
<span style="color:#fff;font-weight:bold">func</span> (o *SyncMap) Set(key <span style="color:#fff;font-weight:bold">string</span>, value <span style="color:#fff;font-weight:bold">interface</span>{}) {
 o.m.Store(key, value)
}

<span style="color:#fff;font-weight:bold">func</span> (o *SyncMap) Del(key <span style="color:#fff;font-weight:bold">string</span>) {
 o.m.Delete(key)
}
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ç®€å•å°è£…äº†ä¸€ä¸‹ï¼Œæµ‹è¯•ä¸ªæ€§èƒ½æ²¡å•¥é—®é¢˜ã€‚</p>
<p>ç°åœ¨æŠŠ Write å¢åŠ ä¹Ÿæ²¡é—®é¢˜äº†ï¼Œå¯æ˜¯çœŸçš„æ²¡é—®é¢˜ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬ç°åœ¨å°æ”¹ä¸€ä¸‹ç¬¬ä¸€ç§ map åŠ äº†ä¸ª RW é”ï¼Œç„¶åå’Œè¿™ç§ map åšä¸€ä¸‹æ¯”è¾ƒçœ‹çœ‹ï¼Ÿ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">type</span> OriginWithRWLock <span style="color:#fff;font-weight:bold">struct</span> {
 m <span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}
 l sync.RWMutex
}

<span style="color:#fff;font-weight:bold">func</span> NewOriginWithRWLock() *OriginWithRWLock {
 <span style="color:#fff;font-weight:bold">return</span> &amp;OriginWithRWLock{
  m: <span style="color:#fff;font-weight:bold">make</span>(<span style="color:#fff;font-weight:bold">map</span>[<span style="color:#fff;font-weight:bold">string</span>]<span style="color:#fff;font-weight:bold">interface</span>{}),
  l: sync.RWMutex{},
 }
}

<span style="color:#fff;font-weight:bold">func</span> (o *OriginWithRWLock) Get(key <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">interface</span>{}, <span style="color:#fff;font-weight:bold">bool</span>) {
 o.l.RLock()
 v, ok := o.m[key]
 o.l.RUnlock()
 <span style="color:#fff;font-weight:bold">return</span> v, ok
}
<span style="color:#fff;font-weight:bold">func</span> (o *OriginWithRWLock) Set(key <span style="color:#fff;font-weight:bold">string</span>, value <span style="color:#fff;font-weight:bold">interface</span>{}) {
 o.l.Lock()
 o.m[key] = value
 o.l.Unlock()
}

<span style="color:#fff;font-weight:bold">func</span> (o *OriginWithRWLock) Del(key <span style="color:#fff;font-weight:bold">string</span>) {
 o.l.Lock()
 <span style="color:#fff;font-weight:bold">delete</span>(o.m, key)
 o.l.Unlock()
}
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åæˆ‘ä»¬è¿™æ¬¡ç”¨ Test é‡Œçš„ Benchmark è¯•è¯•çœ‹ï¼Œä¸ºäº†æ–¹ä¾¿æ¯”è¾ƒï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•° benchmarkMapã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">func</span> benchmarkMap(b *testing.B, hm Map) {
 <span style="color:#fff;font-weight:bold">var</span> wg sync.WaitGroup
 <span style="color:#fff;font-weight:bold">for</span> i := <span style="color:#ff0;font-weight:bold">0</span>; i &lt; b.N; i++ {
  <span style="color:#fff;font-weight:bold">for</span> j := <span style="color:#ff0;font-weight:bold">0</span>; j &lt; Writer; j++ {
   wg.Add(<span style="color:#ff0;font-weight:bold">1</span>)
   <span style="color:#fff;font-weight:bold">go</span> <span style="color:#fff;font-weight:bold">func</span>() {
    <span style="color:#fff;font-weight:bold">for</span> k := <span style="color:#ff0;font-weight:bold">0</span>; k &lt; <span style="color:#ff0;font-weight:bold">100</span>; k++ {
     hm.Set(strconv.Itoa(k), k*k)
     hm.Set(strconv.Itoa(k), k*k)
     hm.Del(strconv.Itoa(k))
    }
    wg.Done()
   }()
  }
  <span style="color:#fff;font-weight:bold">for</span> j := <span style="color:#ff0;font-weight:bold">0</span>; j &lt; Reader; j++ {
   wg.Add(<span style="color:#ff0;font-weight:bold">1</span>)
   <span style="color:#fff;font-weight:bold">go</span> <span style="color:#fff;font-weight:bold">func</span>() {
    <span style="color:#fff;font-weight:bold">for</span> k := <span style="color:#ff0;font-weight:bold">0</span>; k &lt; <span style="color:#ff0;font-weight:bold">100</span>; k++ {
     hm.Get(strconv.Itoa(k))
    }
    wg.Done()
   }()
  }
 }
 wg.Wait()
}

<span style="color:#fff;font-weight:bold">func</span> BenchmarkMaps(b *testing.B) {
 b.Logf(<span style="color:#0ff;font-weight:bold">&#34;Writer: %d,Reader: %d&#34;</span>, Writer, Reader)

 b.Run(<span style="color:#0ff;font-weight:bold">&#34;SyncMap&#34;</span>, <span style="color:#fff;font-weight:bold">func</span>(b *testing.B) {
  hm := NewSyncMap()
  benchmarkMap(b, hm)
 })

 b.Run(<span style="color:#0ff;font-weight:bold">&#34;map with RWLock&#34;</span>, <span style="color:#fff;font-weight:bold">func</span>(b *testing.B) {
  hm := NewOriginWithRWLock()
  benchmarkMap(b, hm)
 })
}

</code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆæ˜¯ BenchMark çš„å‡½æ•°å½“ä½¿ç”¨</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">go</span> test .... -bench=. -benchmem
</code></pre></td></tr></table>
</div>
</div><p>çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Œç„¶åæ¥æµ‹è¯•ä¸¤ç§ Map æ€§èƒ½ï¼Œä¸Šé¢é‚£ä¸ªæ˜¯æµ‹è¯•æ€§èƒ½çš„å‡½æ•°ï¼Œåˆ†åˆ«å¯¹ä¸¤ä¸ªå‡½æ•°çš„è¿›è¡Œæµ‹è¯•~~æ‹­ç›®ä»¥å¾…</p>
<blockquote>
<p>å½“ä¸¤è€…éƒ½æ˜¯ 100 çš„æ—¶å€™</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">
 <span style="color:#fff;font-weight:bold">go</span> test test_map/map_test.<span style="color:#fff;font-weight:bold">go</span>  -v -bench=. -benchmem                                                                                                                         [<span style="color:#ff0;font-weight:bold">14</span>:<span style="color:#ff0;font-weight:bold">12</span>:<span style="color:#ff0;font-weight:bold">59</span>]
goos: darwin
goarch: amd64
BenchmarkMaps
    map_test.<span style="color:#fff;font-weight:bold">go</span>:<span style="color:#ff0;font-weight:bold">73</span>: Writer: <span style="color:#ff0;font-weight:bold">100</span>,Reader: <span style="color:#ff0;font-weight:bold">100</span>
BenchmarkMaps/SyncMap
BenchmarkMaps/SyncMap-<span style="color:#ff0;font-weight:bold">8</span>                       <span style="color:#ff0;font-weight:bold">80</span>          <span style="color:#ff0;font-weight:bold">13374265</span> ns/op         <span style="color:#ff0;font-weight:bold">1710981</span> B/op      <span style="color:#ff0;font-weight:bold">80867</span> allocs/op
BenchmarkMaps/map_with_RWLock
BenchmarkMaps/map_with_RWLock-<span style="color:#ff0;font-weight:bold">8</span>              <span style="color:#ff0;font-weight:bold">100</span>          <span style="color:#ff0;font-weight:bold">12572631</span> ns/op          <span style="color:#ff0;font-weight:bold">155019</span> B/op      <span style="color:#ff0;font-weight:bold">16951</span> allocs/op
PASS
ok      command-line-arguments  <span style="color:#ff0;font-weight:bold">3.323</span>s

</code></pre></td></tr></table>
</div>
</div><p>åŸºæœ¬ä¸Š SyncMap çš„æ•´ä½“æ€§èƒ½æ˜¯ä¼˜äº mapWithRWLock çš„æˆ‘æ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆ</p>
<p>ä»å¤è‡³ä»Šï¼Œäººä»¬ä¸€ç›´åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šåšæ–—äº‰ï¼Œè¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸¤ç§é”çš„å®ç°åŸç†ä¸ä¸€æ ·ã€‚</p>
<!-- raw HTML omitted -->
<p>å½“æˆ‘ä»¬ä½¿ç”¨æ™®é€š Map å¸¦ RWMutex ä¼šå°†æ•´å—å†…å­˜é”ä½ï¼Œç„¶åå…¶ä»–è¯·æ±‚å°±è¦ç­‰å¾…ã€‚
SyncMap æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<!-- raw HTML omitted -->
<p>å®ƒåˆ†ä¸ºä¸¤å—å†…å­˜ï¼ˆå­˜çš„éƒ½æ˜¯æŒ‡é’ˆï¼‰ï¼Œä¸€å—åªè¯»åŒºåŸŸï¼Œä¸€å— Dirty åŒºåŸŸæ”¯æŒè¯»å†™ã€‚</p>
<p>ä¸¤è¾¹çš„æŒ‡é’ˆæŒ‡å‘åŸæ•°æ®ï¼Œå½“éœ€è¦ Get çš„æ—¶å€™ä»–ä¼šæ‰§è¡Œ <strong>Load</strong> æ“ä½œä» Read ä¸­å»è·å–æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼ˆ <strong>miss</strong> ï¼‰å‘ç”Ÿäº†ï¼Œå°±è½¬è€Œä¼šå» dirty ä¸­è·å¾—æ•°æ®å¹¶ä¸”å­˜å…¥ Read ä¸­ã€‚</p>
<p>å½“ <strong>miss</strong> è¶…è¿‡ä¸€å®šæ•°é‡çš„æ—¶å€™ï¼Œä»–å°±ä¼šç”¨åŸå­æ“ä½œæŠŠ dirty çš„æ•°æ® Promote åˆ° ReadOnly ä¸­ã€‚</p>
<p>å› æ­¤ Sync è¿™ç§æœºåˆ¶ï¼Œå¾€å¾€åªé€‚ç”¨äº Key-Value ç›¸å¯¹ç¨³å®šçš„ä¸šåŠ¡æƒ…å†µï¼Œè¯»å¤šå†™å°‘çš„ä¸šåŠ¡ã€‚</p>
<blockquote>
<p>æ‰‹ç—’æƒ³å†™ä¸ªå†…å­˜çš„çœ‹çœ‹åˆ°åº•å¤šèŠ±å¤šå°‘å†…å­˜
go tool pprof æ˜¯ä¸€ä¸ªå·¥å…·å¯ä»¥æŸ¥çœ‹ä»£ç æµ‹è¯„äº§ç”Ÿçš„å†…å­˜æ—¥å¿—</p>
</blockquote>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go">
<span style="color:#fff;font-weight:bold">go</span> test map_test/map_performance_test.<span style="color:#fff;font-weight:bold">go</span> -bench=. -memprofile=mem.prof
<span style="color:#fff;font-weight:bold">go</span> tool pprof <span style="color:#fff;font-weight:bold">map</span>.test mem.prof
(pprof)top
...
      flat  flat%   sum%        cum   cum%
    <span style="color:#ff0;font-weight:bold">1.54</span>GB <span style="color:#ff0;font-weight:bold">57.95</span>% <span style="color:#ff0;font-weight:bold">57.95</span>%     <span style="color:#ff0;font-weight:bold">1.57</span>GB <span style="color:#ff0;font-weight:bold">59.14</span>%  command-line-arguments_test.benchmarkMap.func2
    <span style="color:#ff0;font-weight:bold">0.43</span>GB <span style="color:#ff0;font-weight:bold">16.22</span>% <span style="color:#ff0;font-weight:bold">74.17</span>%     <span style="color:#ff0;font-weight:bold">0.69</span>GB <span style="color:#ff0;font-weight:bold">25.94</span>%  command-line-arguments_test.benchmarkMap.func1

</code></pre></td></tr></table>
</div>
</div><p>ä¸ç”¨è¯´äº†è¿™çœ‹èµ·æ¥ä¸‰å€çš„å†…å­˜æ¶ˆè€—ï¼Œæœç„¶è¶Šå¿«å†…å­˜è¶Šå¤§ã€‚é‚£ä¹ˆï¼Ÿæœ¬æ¬¡æµ‹è¯„åˆ°æ­¤ç»“æŸï¼Ÿ</p>
<p>ï¼ï¼ï¼ å¹¶æ²¡æœ‰ï¼ï¼ï¼
è¿˜æœ‰ä¸€ä¸ªå¤§ä½¬å†™äº†ä¸ª concurrent-map ç”šå¼ï¼Œæˆ‘ä»¬æ¥è§‚æ‘©ä¸€æ³¢ã€‚
<a href="https://github.com/orcaman/concurrent-map" title="concurrent-map" target="_blank" rel="noopener">concurrent-map</a>
</p>
<p>ç«‹é©¬å°è£…ä¸€æ³¢</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-go" data-lang="go"><span style="color:#fff;font-weight:bold">type</span> ConCurrentMap <span style="color:#fff;font-weight:bold">struct</span> {
 m cmap.ConcurrentMap
}

<span style="color:#fff;font-weight:bold">func</span> NewConCurrentMap() *ConCurrentMap {
 conMap := cmap.New()
 <span style="color:#fff;font-weight:bold">return</span> &amp;ConCurrentMap{m: conMap}
}

<span style="color:#fff;font-weight:bold">func</span> (c *ConCurrentMap) Get(key <span style="color:#fff;font-weight:bold">string</span>) (<span style="color:#fff;font-weight:bold">interface</span>{}, <span style="color:#fff;font-weight:bold">bool</span>) {
 v, ok := c.m.Get(key)
 <span style="color:#fff;font-weight:bold">return</span> v, ok
}
<span style="color:#fff;font-weight:bold">func</span> (c *ConCurrentMap) Set(key <span style="color:#fff;font-weight:bold">string</span>, value <span style="color:#fff;font-weight:bold">interface</span>{}) {
 c.m.Set(key, value)
}

<span style="color:#fff;font-weight:bold">func</span> (c *ConCurrentMap) Del(key <span style="color:#fff;font-weight:bold">string</span>) {
 c.m.Remove(key)
}
</code></pre></td></tr></table>
</div>
</div><p>è¿«ä¸åŠå¾…å¼€å§‹æµ‹è¯•ï¼Œå½“ Write=100ï¼ŒReader=100 çš„æ—¶å€™</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">go <span style="color:#fff;font-weight:bold">test</span> test_map/map_test.go  -v -bench=. -benchmem                                                                                                                         [14:24:48]
goos: darwin
goarch: amd64
BenchmarkMaps
    map_test.go:73: Writer: 1000,Reader: <span style="color:#ff0;font-weight:bold">1000</span>
BenchmarkMaps/SyncMap
BenchmarkMaps/SyncMap-8                        <span style="color:#ff0;font-weight:bold">8</span>         <span style="color:#ff0;font-weight:bold">129847762</span> ns/op        <span style="color:#ff0;font-weight:bold">16410356</span> B/op     <span style="color:#ff0;font-weight:bold">785167</span> allocs/op
BenchmarkMaps/map_with_RWLock
BenchmarkMaps/map_with_RWLock-8               <span style="color:#ff0;font-weight:bold">10</span>         <span style="color:#ff0;font-weight:bold">117275854</span> ns/op         <span style="color:#ff0;font-weight:bold">1723905</span> B/op     <span style="color:#ff0;font-weight:bold">169971</span> allocs/op
BenchmarkMaps/CMap
BenchmarkMaps/CMap-8                          <span style="color:#ff0;font-weight:bold">69</span>          <span style="color:#ff0;font-weight:bold">27681675</span> ns/op         <span style="color:#ff0;font-weight:bold">1786702</span> B/op     <span style="color:#ff0;font-weight:bold">169936</span> allocs/op
PASS
ok      command-line-arguments  4.424s

</code></pre></td></tr></table>
</div>
</div><p>é‚£ä¹ˆæˆ‘åŒæ ·åšä¸ªè¡¨æ ¼å§ï¼ŒæŠŠè¯»å†™çš„å‡ ç§æƒ…å†µéƒ½åˆ—å‡ºæ¥</p>
<table>
<thead>
<tr>
<th>R/W</th>
<th>SyncMap</th>
<th>map_with_RWLock</th>
<th>CMap</th>
</tr>
</thead>
<tbody>
<tr>
<td>100/100</td>
<td><code>13657466</code></td>
<td><code>12122735</code></td>
<td><code>1946771</code></td>
</tr>
<tr>
<td>10/100</td>
<td><code>4040595</code></td>
<td><code>11031799</code></td>
<td><code>1770506</code></td>
</tr>
<tr>
<td>100/10</td>
<td><code>1696194</code></td>
<td><code>1916231</code></td>
<td><code>360180</code></td>
</tr>
</tbody>
</table>
<p>æœ€åè¯´ä¸€ä¸‹è¿™ä¸ªå¹¶å‘è¯»mapæ˜¯æ€ä¹ˆæçš„</p>
<!-- raw HTML omitted -->
<p>å·¦è¾¹æ˜¯æ™®é€šçš„mapï¼Œå½“æœ‰è¯»å†™çš„æ—¶å€™é”ä¸Šäº†ï¼Œå…¶ä»–çº¿ç¨‹å°±æ— æ³•è¯»å†™äº†ã€‚å³è¾¹çš„æ˜¯ <strong>concurrentMap</strong> ï¼Œä»–åˆ©ç”¨äº†ä¸€ç§ <strong>partition</strong> çš„æ€æƒ³ï¼ŒæŠŠ <strong>Map</strong> çš„å†…å­˜ <strong>SHARD</strong> ï¼ˆåˆ†å‰²ï¼‰æˆNä»½ï¼Œç„¶åç”¨ä¸åŒçš„ğŸ”é”ä¸Šé”ï¼Œé‚£ä¹ˆé™ä½äº†éœ€è¦èµ„æºè¢«é”çš„æ¦‚ç‡ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ—¥å¸¸ä¸­ç¼–ç¨‹çš„æ—¶å€™å®¹æ˜“é™·å…¥ä¸€ç§è¯¯åŒºï¼Œå°±æ˜¯è¿™é”ï¼Œé‚£é”ï¼Œå…¨é”ä¸Šï¼Œé¢è¯•ä¹Ÿåœ¨é—®å„ç§é”ï¼Œä½†æ˜¯åœ¨çœŸå®QPSæ¯”ä»·é«˜çš„ä¸šåŠ¡ä¸­ï¼Œé”æ˜¯ä¸€ç§å¾ˆå¯æ€•çš„ä¸œè¥¿ï¼Œå¦‚æœèƒ½åœ¨ç¼–ç¨‹çš„æ—¶å€™å¥½å¥½æƒ³æƒ³å†™å‡º **LockFree`çš„ç¨‹åºæ˜¯æœ€å¥½çš„å•Šã€‚</p>
<p>æˆ‘æ˜¯åŒ—äº¬æŸ211çš„æ··å­ï¼Œä»19å¹´10æœˆå¼€å§‹å†™ä¸¤è¡Œgolangåˆ°ç°åœ¨ä¸çŸ¥ä¸è§‰å·²ç»è¿‡å»äº†2ä¸ªæœˆï¼Œä¸Šæ‰‹å°±å¼€å§‹æ‹‰æ¡†æ¶å†™ä»£ç çš„æˆ‘å·²ç»è¿›åŒ–åˆ°å¼€å§‹åˆ†ææ€§èƒ½ï¼Œç„¶åä¼˜åŒ–ä»£ç å•¦ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´æƒ³ä¸€èµ·è®¨è®ºè®¨è®ºï¼Œæ¬¢è¿ã€‚</p>

    </div>


  </article>


  


  <footer class="footer">
  <ul class="footer-links">
    <li>
      <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
    </li>
    <li>
      <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png"
          alt="Img link to Hugo website" width="22" height="22"></a>
    </li>
  </ul>
</footer>

</div>



</body>

</html>

  
</main>